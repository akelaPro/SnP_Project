{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 id="photo-title"></h1>
    <img id="photo-image" class="img-fluid" style="max-height: 400px; object-fit: cover;">
    <p id="photo-description"></p>
    <p>Автор: <span id="photo-author"></span></p>
    <img id="photo-author-avatar" class="rounded-circle" style="width: 50px; height: 50px;">

    <div id="photo-actions" style="display: none;">
        <button id="delete-photo-button" class="btn btn-danger">Удалить</button>
        <button id="restore-photo-button" class="btn btn-success" style="display: none;">Восстановить</button>
    </div>
    <div id="timer"></div>

    <h3>Комментарии:</h3>
    <ul class="list-unstyled" id="comments-list">
    </ul>

    <button id="show-all-comments-button" style="display:none;" class="btn btn-secondary">Показать все комментарии</button>
    <button id="hide-all-comments-button" style="display:none;" class="btn btn-secondary">Скрыть все комментарии</button>

    <div id="comment-section">
        <form id="comment-form" class="mb-4" style="display: none;">
            {% csrf_token %}
            <div class="form-group">
                <textarea name="text" class="form-control" required placeholder="Добавьте комментарий..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Добавить комментарий</button>
        </form>
        <p id="login-prompt-comment">Чтобы оставить комментарий, пожалуйста, <a href="{% url 'galery:login_template' %}">войдите</a> или <a href="{% url 'galery:registration_template' %}">зарегистрируйтесь</a>.</p>
    </div>

    <h3>Лайки: <span id="votes-count">0</span></h3>
    <div id="like-section">
        <button id="like-button" class="btn btn-success" style="display: none;">Поставить лайк</button>
        <button id="unlike-button" class="btn btn-danger" style="display:none;">Убрать лайк</button>
        <p id="login-prompt-like">Чтобы поставить лайк, пожалуйста, <a href="{% url 'galery:login_template' %}">войдите</a> или <a href="{% url 'galery:registration_template' %}">зарегистрируйтесь</a>.</p>
    </div>
</div>

<script>
$(document).ready(function() {
    const photoId = window.location.pathname.split('/').filter(Boolean).pop();
    let accessToken = localStorage.getItem('accessToken');

    const commentForm = $('#comment-form');
    const likeButton = $('#like-button');
    const unlikeButton = $('#unlike-button');
    const loginPromptComment = $('#login-prompt-comment');
    const loginPromptLike = $('#login-prompt-like');
    const deletePhotoButton = $('#delete-photo-button');
    const restorePhotoButton = $('#restore-photo-button');
    const photoActions = $('#photo-actions');
    const timerDiv = $('#timer');
    const showAllCommentsButton = $('#show-all-comments-button');
    const hideAllCommentsButton = $('#hide-all-comments-button');

    let allCommentsLoaded = false;

    function updateAuthUI() {
        if (accessToken) {
            commentForm.show();
            likeButton.show();
            loginPromptComment.hide();
            loginPromptLike.hide();
        } else {
            commentForm.hide();
            likeButton.hide();
            unlikeButton.hide();
            loginPromptComment.show();
            loginPromptLike.show();
        }
    }

    function refreshToken() {
    const refreshTokenValue = localStorage.getItem('refreshToken');
    if (!refreshTokenValue) {
        console.warn("No refresh token available. Redirecting to login.");
        window.location.href = "{% url 'galery:login_template' %}";
        return Promise.reject("No refresh token available.");
    }

    return new Promise((resolve, reject) => {
        const data = JSON.stringify({ refresh: refreshTokenValue });
        $.ajax({
            url: '/api/refresh/',
            method: 'POST',
            contentType: 'application/json',
            data: data,// Правильное использование data
            headers: {
                'X-CSRFToken': '{{ csrf_token }}' // Убедитесь, что CSRF-токен передается правильно
            },
            success: function(data) {
                localStorage.setItem('accessToken', data.access);
                localStorage.setItem('refreshToken', data.refresh);
                accessToken = data.access;
                resolve({ access: data.access, refresh: data.refresh });
            },
            error: function(xhr) {
                console.error("Failed to refresh token:", xhr);
                localStorage.removeItem('refreshToken');
                window.location.href = "/galery/login/";
                reject(xhr);
            }
        });
    });
}

    function loadPhotoDetails() {
        $.ajax({
            url: `/api/photos/${photoId}/?include_deleted=true`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            success: function(photo) {
                console.log('Photo data:', photo);

                $('#photo-title').text(photo.title);
                $('#photo-image').attr('src', photo.image || '');
                $('#photo-author').text(photo.author.username);
                $('#photo-author-avatar').attr('src', photo.author.avatar || '');
                $('#photo-description').text(photo.description);
                $('#votes-count').text(photo.votes_count || 0);

                window.canEdit = photo.can_edit;
                console.log('canEdit:', window.canEdit);
                console.log('photo.moderation:', photo.moderation, 'photo.deleted_at:', photo.deleted_at);

                if (window.canEdit) {
                    if (photo.moderation === '1' && photo.deleted_at) {
                        deletePhotoButton.hide();
                        restorePhotoButton.show();
                    } else {
                        deletePhotoButton.show();
                        restorePhotoButton.hide();
                    }
                    photoActions.show();
                } else {
                    photoActions.hide();
                }

                if (photo.moderation === '1') {
                    const deletedAt = new Date(photo.deleted_at);
                    const deleteTime = deletedAt.getTime() + 35000;
                    const timerInterval = setInterval(updateTimer, 1000);
                    const updateTimer = () => {
                        const now = new Date().getTime();
                        const remaining = deleteTime - now;

                        if (remaining > 0) {
                            const seconds = Math.floor(remaining / 1000);
                            timerDiv.html(`
                                <div class="alert alert-warning">
                                    Фото будет удалено через ${seconds} сек.
                                    <button id="cancel-delete" class="btn btn-sm btn-success">Отменить</button>
                                </div>
                            `);
                        } else {
                            timerDiv.html('<div class="alert alert-danger">Фото удалено</div>');
                            clearInterval(timerInterval);
                            deletePhotoButton.hide();
                            restorePhotoButton.hide();
                        }
                    };

                    updateTimer();
                    
                } else {
                    timerDiv.empty();
                }

                loadInitialComments();
            },
            error: function(xhr) {
                console.error('Ошибка при загрузке фотографии:', xhr.responseText);
                photoActions.hide();

                if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                            loadPhotoDetails();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            }
        });
    }

    function loadInitialComments() {
        $.get(`/api/comments/?photo=${photoId}`)
            .done(comments => {
                const commentsList = $('#comments-list');
                commentsList.empty();

                const rootComments = comments.filter(comment => !comment.parent);
                rootComments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                const initialRootComments = rootComments.slice(0, 2);

                initialRootComments.forEach(comment => {
                    const commentHTML = buildCommentHTML(comment, comments);
                    commentsList.append(commentHTML);
                });

                if (rootComments.length > 2) {
                    showAllCommentsButton.show();
                    showAllCommentsButton.off('click').on('click', function() {
                        loadAllComments();
                    });
                } else {
                    showAllCommentsButton.hide();
                }
            })
            .fail(function(xhr) {
              console.error('Ошибка при загрузке комментариев:', xhr.responseText);
                if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                            loadInitialComments();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            });
    }


    function loadAllComments() {
        $.get(`/api/comments/?photo=${photoId}`)
            .done(comments => {
                const commentsList = $('#comments-list');
                commentsList.empty();

                const rootComments = comments.filter(comment => !comment.parent);
                rootComments.forEach(comment => {
                    const commentHTML = buildCommentHTML(comment, comments);
                    commentsList.append(commentHTML);
                });

                showAllCommentsButton.hide();
                hideAllCommentsButton.show();
                allCommentsLoaded = true;
            })
             .fail(function(xhr) {
                console.error('Ошибка при загрузке всех комментариев:', xhr.responseText);
                if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                            loadAllComments();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            });
    }


    function hideAllComments() {
        $('#comments-list').empty();
        showAllCommentsButton.show();
        hideAllCommentsButton.hide();
        loadInitialComments();
    }


    function buildCommentHTML(comment, allComments, level = 0) {
        let html = `
            <li id="comment-${comment.id}" style="margin-left: ${level * 30}px">
                ${comment.text} - ${comment.author.username}
                <button class="reply-button" data-comment-id="${comment.id}">Ответить</button>`;

        const replies = allComments.filter(c => c.parent === comment.id);
        const hasReplies = replies.length > 0;

        if (hasReplies) {
            const repliesVisible = localStorage.getItem(`repliesVisible-${comment.id}`) === 'true';
            const buttonText = repliesVisible ? 'Скрыть ответы' : 'Показать ответы';

            html += `<button class="toggle-replies-button" data-comment-id="${comment.id}">${buttonText}</button>`;

            const repliesStyle = repliesVisible ? '' : 'style="display: none;"';
            html += `<ul class="replies" id="replies-${comment.id}" ${repliesStyle}>`;

            replies.forEach(reply => {
                html += buildCommentHTML(reply, allComments, level + 1);
            });

            html += `</ul>`;
        }

        html += `</li>`;
        return html;
    }

    $(document).on('click', '.toggle-replies-button', function() {
        const commentId = $(this).data('comment-id');
        const repliesContainer = $(`#replies-${commentId}`);
        const button = $(this);

        const repliesVisible = repliesContainer.is(':visible');
        const newRepliesVisible = !repliesVisible;

        repliesContainer.toggle();

        const buttonText = newRepliesVisible ? 'Скрыть ответы' : 'Показать ответы';
        button.text(buttonText);

        localStorage.setItem(`repliesVisible-${commentId}`, newRepliesVisible);
    });

    $('#comment-form').submit(function(e) {
        console.log('Основная форма отправлена');
        e.preventDefault();
        const data = JSON.stringify({
            text: $(this).find('textarea').val(),
            photo: photoId
        });

        $.ajax({
            url: `/api/comments/`,
            type: 'POST',
            contentType: 'application/json',
            data,
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function() {
                loadInitialComments();
                $(this).find('textarea').val('');
            },
            error: function(xhr) {
                console.error("Ошибка при отправке комментария:", xhr.responseText);

                 if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                             $.ajax(this);
                            loadInitialComments();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            }
        });
    });

    $(document).on('submit', '[id^="reply-form-"]', function(e) {
        console.log('Форма ответа отправлена');
        e.preventDefault();
        const parentId = $(this).data('parent-id');
        const text = $(this).find('.reply-text').val();

        const data = JSON.stringify({
            text: text,
            photo: photoId,
            parent: parentId
        });

        $.ajax({
            url: `/api/comments/`,
            type: 'POST',
            contentType: 'application/json',
            data,
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function() {
                loadInitialComments();
                $(this).find('textarea').val('');
            },
            error: function(xhr) {
                console.error("Ошибка при отправке комментария:", xhr.responseText);
                if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                            loadInitialComments();
                            $.ajax(this);
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            }
        });
    });

    $(document).on('click', '.reply-button', function() {
        const commentId = $(this).data('comment-id');
        const replyForm = `
            <form id="reply-form-${commentId}" class="reply-form" data-parent-id="${commentId}">
                <textarea class="reply-text"></textarea>
                <button type="submit">Отправить ответ</button>
                <button type="button" class="cancel-reply">Отменить</button>
            </form>
        `;
        $(this).after(replyForm);
    });

    $(document).on('click', '.cancel-reply', function() {
        $(this).closest('.reply-form').remove();
    });
    
    $('#like-button').click(function() {
        const data = JSON.stringify({ photo: photoId });

        // Check if accessToken exists
        if (!accessToken) {
           console.error('Токен доступа отсутствует');
           window.location.href = "{% url 'galery:login_template' %}";
           return;
       }

        $.ajax({
            url: `/api/votes/`,
            method: 'POST',  // Используем POST для создания лайка
            data,
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'  // Отправляем CSRF-токен
            },
            success: function(response) {
                const voteId = response.id;
                $('#votes-count').text(parseInt($('#votes-count').text()) + 1);
                $(this).hide();
                $('#unlike-button').show();
                $('#unlike-button').data('voteId', voteId);
            },
            error: function(xhr) {
              console.error('Ошибка при постановке лайка:', xhr.responseText);
              if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                           $('#like-button').click();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            }
        });
    });

    $('#unlike-button').click(function() {
        const voteId = $(this).data('voteId');
        $.ajax({
            url: `/api/votes/${voteId}/`,
            type: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'
            },
        })
        .done(() => {
            $('#votes-count').text(parseInt($('#votes-count').text()) - 1);
            $(this).hide();
            $('#like-button').show();
        })
         .fail(function(xhr) {
             console.error('Ошибка при удалении лайка:', xhr.responseText);
                if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                             $('#unlike-button').click();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            });
    });

    $('#delete-photo-button').click(function() {
        $.ajax({
            url: `/api/photos/${photoId}/delete_photo/`,
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function() {
                window.location.href = '/galery/profile/';
            },
            error: function(xhr) {
                console.error('Ошибка при удалении фотографии:', xhr.responseText);
                alert('Ошибка при удалении фотографии.');

                  if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                            $('#delete-photo-button').click();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            }
        });
    });

    $('#restore-photo-button').click(function() {
        $.ajax({
            url: `/api/photos/${photoId}/restore_photo/`,
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                loadPhotoDetails();
            },
            error: function(xhr) {
                console.error('Ошибка при восстановлении фотографии:', xhr.responseText);
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    alert('Ошибка при восстановлении фотографии: ' + (errorData.detail || 'Неизвестная ошибка'));
                } catch (e) {
                    alert('Ошибка при восстановлении фотографии: ' + xhr.responseText);
                }

                  if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                            $('#restore-photo-button').click();
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            }
        });
    });

    $(document).on('click', '#cancel-delete', function() {
        $.post(`/api/photos/${photoId}/restore_photo/`,{},
          {
                headers: {
                'Authorization': 'Bearer ' + accessToken,
                'X-CSRFToken': '{{ csrf_token }}'
            }})
            .done(() => location.reload())
             .fail(function(xhr) {
                 console.error('Ошибка при отмене удаления:', xhr.responseText);
                if (xhr.status === 401) {
                    refreshToken()
                        .then(newTokens => {
                            accessToken = newTokens.access;
                             $(document).on('click', '#cancel-delete', function() {
                                   $.post(`/api/photos/${photoId}/restore_photo/`,{},
                                   {
                                        headers: {
                                        'Authorization': 'Bearer ' + accessToken,
                                        'X-CSRFToken': '{{ csrf_token }}'
                                    }})
                                    .done(() => location.reload());
                               });
                        })
                        .catch(error => {
                            console.error("Failed to refresh token:", error);
                            window.location.href = "{% url 'galery:login_template' %}";
                        });
                }
            });
    });

    hideAllCommentsButton.click(function() {
        hideAllComments();
    });

    // Use localStorage.getItem() to get accessToken
    if (localStorage.getItem('accessToken')) {
    accessToken = localStorage.getItem('accessToken');
    } else {
    // If token is missing, redirect user to login page
    window.location.href = '{% url "galery:login_template" %}';
    }

    loadPhotoDetails();
    updateAuthUI();
});
</script>
{% endblock %}