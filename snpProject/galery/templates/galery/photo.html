{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 id="photo-title"></h1>
    <img id="photo-image" class="img-fluid" style="max-height: 400px; object-fit: cover;">
    <p id="photo-description"></p>
    <p>Автор: <span id="photo-author"></span></p>
    <img id="photo-author-avatar" class="rounded-circle" style="width: 50px; height: 50px;">

    <h3>Комментарии:</h3>
    <ul class="list-unstyled" id="comments-list"></ul>

    <div id="comment-section">
        <form id="comment-form" class="mb-4" style="display: none;">
            {% csrf_token %}
            <div class="form-group">
                <textarea name="text" class="form-control" required placeholder="Добавьте комментарий..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Добавить комментарий</button>
        </form>
        <p id="login-prompt-comment">Чтобы оставить комментарий, пожалуйста, <a href="{% url 'galery:login_template' %}">войдите</a> или <a href="{% url 'galery:registration_template' %}">зарегистрируйтесь</a>.</p>
    </div>

    <h3>Лайки: <span id="votes-count">0</span></h3>
    <div id="like-section">
        <button id="like-button" class="btn btn-success" style="display: none;">Поставить лайк</button>
        <button id="unlike-button" class="btn btn-danger" style="display:none;">Убрать лайк</button>
        <p id="login-prompt-like">Чтобы поставить лайк, пожалуйста, <a href="{% url 'galery:login_template' %}">войдите</a> или <a href="{% url 'galery:registration_template' %}">зарегистрируйтесь</a>.</p>
    </div>
</div>

<script>
$(document).ready(function() {
    const photoId = window.location.pathname.split('/').filter(Boolean).pop();
    let authToken = localStorage.getItem('authToken');

    const commentForm = $('#comment-form');
    const likeButton = $('#like-button');
    const unlikeButton = $('#unlike-button');
    const loginPromptComment = $('#login-prompt-comment');
    const loginPromptLike = $('#login-prompt-like');

    $.ajaxSetup({
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'Authorization': authToken ? `Token ${authToken}` : ''
        }
    });

    function updateAuthUI() {
        authToken = localStorage.getItem('authToken'); // Обновляем токен
        if (authToken) {
            commentForm.show();
            likeButton.show();
            loginPromptComment.hide();
            loginPromptLike.hide();
        } else {
            commentForm.hide();
            likeButton.hide();
            unlikeButton.hide(); // Ensure unlike is hidden too
            loginPromptComment.show();
            loginPromptLike.show();
        }

        // Update AJAX headers after checking auth state:
        $.ajaxSetup({
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                'Authorization': authToken ? `Token ${authToken}` : ''
            }
        });
    }

    function loadPhotoDetails() {
        $.get(`/API/api/photos/${photoId}/`)
            .done(photo => {
                $('#photo-title').text(photo.title);
                $('#photo-image').attr('src', photo.image || '');
                $('#photo-author').text(photo.author.username);
                $('#photo-author-avatar').attr('src', photo.author.avatar || '');
                $('#photo-description').text(photo.description);
                $('#votes-count').text(photo.votes_count || 0);

                // Visibility of like/unlike buttons is now controlled by updateAuthUI
                //if (photo.has_liked) {
                //    likeButton.hide();
                //    unlikeButton.show();
                //} else {
                //    likeButton.show();
                //    unlikeButton.hide();
                //}

                loadComments();
            })
            .fail(console.error);
    }

    function loadComments() {
        $.get(`/API/api/comments/?photo=${photoId}`)
            .done(comments => {
                const commentsList = $('#comments-list');
                commentsList.empty();
                comments.forEach(comment => {
                    commentsList.append(`<li>${comment.text} - ${comment.author.username}</li>`);
                });
            })
            .fail(console.error);
    }

    $('#comment-form').submit(function(e) {
        e.preventDefault();
        const data = JSON.stringify({
            text: $(this).find('textarea').val(),
            photo: photoId
        });

        $.post(`/API/api/comments/`, data)
            .done(() => {
                loadComments();
                $(this).find('textarea').val('');
            })
            .fail(console.error);
    });

    $('#like-button').click(function() {
        const data = JSON.stringify({ photo: photoId });
        $.post(`/API/api/votes/`, data, null, 'json')
            .done(response => {
                const voteId = response.id;
                $('#votes-count').text(parseInt($('#votes-count').text()) + 1);
                $(this).hide();
                $('#unlike-button').show();
                $('#unlike-button').data('voteId', voteId);
            })
            .fail(console.error);
    });

    $('#unlike-button').click(function() {
        const voteId = $(this).data('voteId');
        $.ajax({
            url: `/API/api/votes/${voteId}/`,
            type: 'DELETE'
        })
        .done(() => {
            $('#votes-count').text(parseInt($('#votes-count').text()) - 1);
            $(this).hide();
            $('#like-button').show();
        })
        .fail(console.error);
    });

    loadPhotoDetails();
    updateAuthUI();

    // Listen for changes in localStorage (e.g., after login/logout)
    window.addEventListener('storage', function(event) {
        if (event.key === 'authToken') {
            updateAuthUI();
        }
    });
});
</script>
{% endblock %}