{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 id="photo-title"></h1>
    <img id="photo-image" class="img-fluid" style="max-height: 400px; object-fit: cover;">

    <p id="photo-description"></p>
    <p>Автор: <span id="photo-author"></span></p>
    <img id="photo-author-avatar" class="rounded-circle" style="width: 50px; height: 50px;">

    <h3>Комментарии:</h3>
    <ul class="list-unstyled" id="comments-list"></ul>

    {% if user.is_authenticated %}
    <form id="comment-form" class="mb-4">
        {% csrf_token %}
        <div class="form-group">
            <textarea name="text" class="form-control" required placeholder="Добавьте комментарий..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Добавить комментарий</button>
    </form>
    {% endif %}

    <div id="photo-actions"></div>
    <h3 id="likes-count">Лайки: <span id="votes-count">0</span></h3>
    <div id="like-button-container"></div>
</div>

<script>
$(document).ready(function() {
    const photoId = window.location.pathname.split('/').filter(Boolean).pop();
    
    // Установка заголовков для AJAX-запросов
    $.ajaxSetup({
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    });

    function loadPhotoDetails() {
    $.get(`/api/photos/${photoId}/`)
        .done(photo => {
            $('#photo-title').text(photo.title);
            $('#photo-image').attr('src', photo.image || '');
            $('#photo-author').text(photo.author.username);
            $('#photo-author-avatar').attr('src', photo.author.avatar || '');
            $('#photo-description').text(photo.description);
            $('#votes-count').text(photo.votes.length);

            // Загрузка комментариев
            loadComments();

            // Остальная часть кода...
        })
        .fail(console.error);
}

function loadComments() {
    $.get(`/api/comments/?photo=${photoId}`)
        .done(comments => {
            const commentsList = $('#comments-list');
            commentsList.empty(); // Очищаем список перед добавлением новых комментариев
            comments.forEach(comment => {
                commentsList.append(`<li>${comment.text} - ${comment.author.username}</li>`);
            });
        })
        .fail(console.error);
}

// Обработчик отправки комментария
$('#comment-form').submit(function(e) {
    e.preventDefault();
    const data = JSON.stringify({
        text: $(this).find('textarea').val(),
        photo: photoId
    });

    $.post('/api/comments/', data)
        .done(() => {
            loadPhotoDetails(); // Обновляем детали фотографии и комментарии
            $(this).find('textarea').val(''); // Очищаем поле ввода
        })
        .fail(console.error);
});


    // Обработчики действий
    $(document)
        .on('click', '.delete-photo', () => {
            $.ajax(`/api/photos/${photoId}/`, { method: 'DELETE' })
                .done(() => {
                    alert('Фотография помечена на удаление.');
                    location.reload();
                })
                .fail(console.error);
        })
        .on('click', '.restore-photo', () => {
            $.post(`/galery/api/photos/${photoId}/restore/`) // Corrected URL
                .done(() => {
                    alert('Фотография восстановлена.');
                    location.reload();
                })
                .fail(console.error);
        });

    loadPhotoDetails();
});
</script>
{% endblock %}